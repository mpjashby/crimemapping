---
title: "Crime Mapping: Mapping crime series"
description: "Learn how to map crime series, including mapping movement over time and the journey to crime."
output: 
  learnr::tutorial:
    progressive: true
    css: "css/tutorial_style.css"
runtime: shiny_prerendered
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
library(learnr)
tutorial_options(exercise.timelimit = 120)
knitr::opts_chunk$set(echo = FALSE, fig.align='center')

# Load packages
library(ggmap)
library(ggrepel)
library(ggspatial)
library(patchwork)
library(sf)
library(tidyverse)

# Copy files
if (!dir.exists("css")) dir.create("css")
walk(
  dir("../css/"), 
  ~ file.copy(str_glue("../css/{.}"), str_glue("css/{.}"), overwrite = TRUE)
)

# Load data --------------------------------------------------------------------


## Hungerford data ----
hungerford_shootings <- tribble(
  ~latitude, ~longitude, ~victims,
  51.4078, -1.6683, "Susan GODFREY†",
  51.4094, -1.5779, "Kakaub DEAN",
  51.4116, -1.5147, "Roland MASON†\nSheila MASON†\nMarjorie JACKSON\nLisa MILDENHALL",
  51.4112, -1.5119, "Kenneth CLEMENTS†",
  51.4115, -1.5140, "Roger BRERETON†\nLinda CHAPMAN\nAlison CHAPMAN",
  51.4116, -1.5151, "Abdur KHAN†\nAlan LEPETIT\nHazel HASLETT\nGeorge WHITE†\nDorothy RYAN†\nIvor JACKSON",
  51.4103, -1.5132, "Betty TOLLADAY",
  51.4081, -1.5132, "Francis BUTLER†",
  51.4079, -1.5144, "Marcus BARNARD†",
  51.4080, -1.5150, "Ann HONEYBONE",
  51.4098, -1.5156, "John STORMS",
  51.4102, -1.5156, "Douglas WAINWRIGHT†\nKathleen WAINWRIGHT\nKevin LANCE\nEric VARDY†",
  51.4088, -1.5173, "Sandra HILL†",
  51.4076, -1.5174, "Victor GIBBS†\nMyrtle GIBBS†\nMichael JENNINGS\nMyra GEATER",
  51.4065, -1.5175, "Ian PLAYLE†",
  51.4062, -1.5152, "George NOON"
) %>% 
  mutate(order = row_number()) %>% 
  select(victims, order, longitude, latitude) %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>% 
  st_transform(27700) %>% 
  {
    bind_cols(., as_tibble(st_coordinates(.))) %>% 
      rename(easting = X, northing = Y)
  } %>% 
  st_drop_geometry() %>% 
  mutate(across(c(easting, northing), as.integer))

hungerford_sf <- hungerford_shootings %>%
  arrange(order) %>% 
  st_as_sf(coords = c("easting", "northing"), crs = 27700) %>% 
  st_transform(4326)

hungerford_wgs84 <- hungerford_sf %>% 
  st_coordinates() %>% 
  as_tibble() %>% 
  janitor::clean_names() %>% 
  mutate(order = row_number())

hungerford_lines <- hungerford_wgs84 %>% 
  rename(x_end = x, y_end = y) %>% 
  mutate(x_start = lag(x_end), y_start = lag(y_end)) %>% 
  slice(2:n())

hungerford_basemap <- hungerford_sf %>% 
  st_transform(27700) %>% 
  st_buffer(1000) %>% 
  st_transform(4326) %>% 
  st_bbox() %>% 
  set_names(c("left", "bottom", "right", "top")) %>%
  get_stamenmap(zoom = 13, maptype = "toner-lite")

hungerford_town_bbox <- hungerford_sf %>% 
  slice(3:n()) %>% 
  st_transform(27700) %>% 
  st_buffer(100) %>% 
  st_transform(4326) %>% 
  st_bbox()

hungerford_town_basemap <- hungerford_town_bbox %>% 
  set_names(c("left", "bottom", "right", "top")) %>%
  get_stamenmap(zoom = 16, maptype = "toner-lite")



# Create stored maps -----------------------------------------------------------

hungerford_map_overall <- ggmap(hungerford_basemap) +
  geom_curve(
    aes(x = x_start, y = y_start, xend = x_end, yend = y_end),
    data = hungerford_lines, 
    inherit.aes = FALSE,
    na.rm = TRUE,
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    curvature = -0.2,
    colour = "orange3"
  ) +
  geom_point(
    aes(x = x, y = y), 
    data = hungerford_wgs84, 
    inherit.aes = FALSE,
    na.rm = TRUE,
    shape = 21,
    colour = "white",
    fill = "orange3",
    size = 3
  ) +
  geom_label_repel(
    aes(x = x, y = y, label = order),
    data = filter(hungerford_wgs84, order %in% 1:2), 
    inherit.aes = FALSE,
    na.rm = TRUE,
    colour = "white",
    fill = "orange3",
    fontface = "bold",
    label.size = NA,
  ) +
  annotation_scale(style = "ticks", line_col = "grey40", text_col = "grey40") +
  labs(
    title = " Shootings in Wiltshire"
  ) +
  coord_sf(crs = 4326) +
  theme_void() +
  theme(
    panel.border = element_rect(colour = "grey20", fill = NA),
    plot.title = element_text(margin = margin(b = -18))
  )

hungerford_map_town <- ggmap(hungerford_town_basemap) +
  geom_curve(
    aes(x = x_start, y = y_start, xend = x_end, yend = y_end),
    data = hungerford_lines, 
    inherit.aes = FALSE,
    na.rm = TRUE,
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    curvature = -0.2,
    colour = "orange3",
    size = 1
  ) +
  geom_point(
    aes(x = x, y = y), 
    data = hungerford_wgs84, 
    inherit.aes = FALSE,
    na.rm = TRUE,
    shape = 21,
    colour = "white",
    fill = "orange3",
    size = 3
  ) +
  geom_label_repel(
    aes(x = x, y = y, label = order),
    data = hungerford_wgs84, 
    inherit.aes = FALSE,
    na.rm = TRUE,
    colour = "white",
    fill = "orange3",
    fontface = "bold",
    label.size = NA,
  ) +
  annotation_scale(style = "ticks", line_col = "grey40", text_col = "grey40") +
  coord_sf(crs = 4326) +
  labs(
    title = "Shootings in Hungerford town"
  ) +
  theme_void() +
  theme(
    panel.border = element_rect(colour = "grey20", fill = NA),
    plot.margin = margin(t = 12)
  )

hungerford_map_overall2 <- hungerford_map_overall + 
  geom_sf(
    data = st_as_sfc(hungerford_town_bbox), 
    inherit.aes = FALSE, 
    fill = NA
  ) +
  annotate(
    geom = "label", 
    x = pluck(hungerford_town_bbox, "xmin"), 
    y = pluck(hungerford_town_bbox, "ymin"),
    label = "area covered\nby map below",
    hjust = 1,
    label.size = NA,
    lineheight = 0.9,
    size = 2.5,
    vjust = 1
  )
```


<!-- Case linkage: http://eknygos.lsmuni.lt/springer/605/117-133.pdf -->


## Introduction

It's common in crime mapping to treat each crime as a separate event. But a 
large proportion of crimes are committed by a relatively small proportion of all
the people who commit crime. These persistent or repeat offenders commit crimes
frequently, maybe several times a day in the case of some people. One type of
repeat offending is the *crime series*, in which an offender or group of 
offenders commits the same or related crimes in different places over time. 

One of the difficulties in studying serial offending is in identifying which 
offences are committed by the same offender. *Case linkage* is the process of 
identifying crime series by looking for similarities in the method used by an 
offender (e.g. entering a house by  breaking a lock on a side door out of sight 
from the street) or by evidence left at the scene (such as fingerprints or DNA). 
Case linkage is typically an imperfect process -- investigators might believe 
that two offences were committed by the same person, but in most cases they are 
unlikely to know for sure unless the offender has been caught (and sometimes not
even then).

Crime mapping can help police and other agencies to understand crime series. In
this tutorial we will learn how to map linked cases.


### The case used in this tutorial

Due to the uncertainty of case linkage, there is little publicly available data
on the locations of serial crimes. The available data tends to focus on serial
murders. To minimise the likelihood of anyone taking this course having been
directly affected by -- or know anyone affected by -- the cases we use in this
tutorial, we will use a historical example.

```{r include=FALSE}
hungerford_murder_count <- hungerford_shootings %>% 
  mutate(murder_count = str_count(victims, "†")) %>% 
  summarise(murder_count = sum(murder_count)) %>% 
  pull(murder_count)
```

<p class="full-width-image image-border"><img src="images/roger_brereton.jpg" alt="Photograph from the funeral of police constable Roger Brereton, one of the people killed in the Hungerford Massacre"></p>

The [Hungerford massacre](https://en.wikipedia.org/wiki/Hungerford_massacre) 
occurred in southern England in August 1987, when a marauding attacker killed 
`r hungerford_murder_count` people and shot many others in the space of about 90 
minutes. We will use a dataset called `hungerford_shootings` that contains the
names of each victim and the approximate location at which they were shot 
(recorded as eastings and northings in the British National Grid). This data is 
taken from the 
[official report into the massacre](https://www.jesip.org.uk/uploads/media/incident_reports_and_inquiries/Hungerford%20Shootings.pdf). The `order` column shows the order in which the victims were
shot. These are the first few rows of the dataset (the dagger symbol † shows 
that the victim was killed):

```{r}
hungerford_shootings %>% 
  mutate(victims = str_replace_all(victims, "\\n", ", ")) %>% 
  head(5) %>% 
  knitr::kable()
```

<p class="credits"><a href="https://www.getreading.co.uk/news/berkshire-history/gallery/30-years-hungerford-massacre-13495555">Photograph of PC Roger Brereton's funeral from Berkshire Live</a></p>

## Mapping linked cases

Mapping crime series can be useful for several reasons. For example, a map of a
crime series might help the jurors in a criminal trial to better understand the
sequence of events that the suspect is accused of. This can be especially 
helpful if the sequence is complicated or especially long.

At the moment, the `hungerford_shootings` dataset contains the *point* location 
of each event and the order in which they occurred. To show a sequence of events 
on a map, we need to link each event with those that happened immediately before 
and after it. 

```{r}
hungerford_shootings %>% 
  mutate(victims = str_replace_all(victims, "\\n", ", ")) %>% 
  head(5) %>% 
  knitr::kable()
```

One way to do this is to draw lines on the map connecting each incident in turn. 
To generate lines between the points, we:

  1. `arrange()` the data using so that the rows are sorted from the first 
     shooting to the last (this will be important at step 6).
  2. Since the co-ordinates are represented using the British National Grid but
     we will need to plot them on a map that uses the WGS84 co-ordinate system,
     convert the data to an SF object using `st_as_sf()`. 
  3. Transform the data to WGS84 using `st_transform()`. Extract the 
     co-ordinates from this transformed SF object using  `st_coordinates()`, 
     since we want to manipulate the co-ordinates directly (at step 6) and 
     because the `geom_segment()` function we will use to plot the lines needs 
     the co-ordinates stored in separate columns as it does not understand SF 
     objects. Convert the result produced by `st_coordinates()` to a tibble with 
     `as_tibble()` and add a column representing the order in which the
     shootings took place using `mutate()`.
  4. `rename()` the columns containing the co-ordinates to make it clear these 
      co-ordinates will represent the *end* of each line.
  5. Use `mutate()` and `lag()` to create two new columns containing the `x` 
     and `y` co-ordinates from the line *above* each line in the data. These 
     co-ordinates will represent the start of each line.
  6. `slice()` the data to remove the first line, since the number of lines 
     connecting the points is one fewer than the number of points. `n()` in the
     code below is a helper function representing the number of rows in the
     dataset.

We will store the result of step 2 in an object called `hungerford_sf` since
we can also use this to generate a bounding box later, and the result of step 3
in an object called `hungerford_wgs84` because we can use it to plot the points
themselves on the map.

```{r linked-exercise1, exercise=TRUE, exercise.lines=21, out.width="100%"}
library(sf)
library(tidyverse)

hungerford_sf <- hungerford_shootings %>%
  arrange(order) %>% 
  st_as_sf(coords = c("easting", "northing"), crs = 27700)

hungerford_wgs84 <- hungerford_sf %>% 
  st_transform(4326) %>% 
  st_coordinates() %>% 
  as_tibble() %>% 
  janitor::clean_names() %>% 
  mutate(order = row_number())

hungerford_lines <- hungerford_wgs84 %>% 
  rename(x_end = x, y_end = y) %>% 
  mutate(x_start = lag(x_end), y_start = lag(y_end)) %>% 
  slice(2:n())

head(hungerford_lines)
```

Now we have an object containing the start and end points of lines linking each 
point in the sequence of shootings at Hungerford, we can plot these on a map 
with a base map.

```{r linked-exercise2, exercise=TRUE, exercise.lines=27, out.width="100%"}
library(ggmap)

# Since `hungerford_sf` uses the British National Grid CRS, we can generate a
# 1km buffer around it to make it easier to see the data points. Then transform 
# the points back to the WGS84 co-ordinate system used by functions from the 
# ggmap() package and download the base map tiles.
hungerford_basemap <- hungerford_sf %>% 
  st_buffer(1000) %>% 
  st_transform(4326) %>% 
  st_bbox() %>% 
  set_names(c("left", "bottom", "right", "top")) %>%
  get_stamenmap(zoom = 13, maptype = "toner-lite")

# Plot the map
ggmap(hungerford_basemap) +
  # Plot sequence of events as lines
  geom_segment(
    aes(x = x_start, y = y_start, xend = x_end, yend = y_end),
    data = hungerford_lines, 
    inherit.aes = FALSE,
    colour = "grey40"
  ) +
  # Plot shooting locations as points
  geom_point(aes(x = x, y = y), data = hungerford_wgs84, inherit.aes = FALSE) +
  theme_void()
```

This map shows the sequence of events, but there are at least three ways that we
can make it better.

  1. We don't know which order to move through the sequence of lines. We can 
     deal with this by adding arrows to show the direction of travel.
  2. The straight lines make it look like the offender travelled across fields
     between locations, which is probably not true. Since we do not have data on
     what routes the offender took, we can replace the straight lines with 
     curves to indicate that the exact route is unknown.
  3. Because the first two shootings occurred outside the town, the map has to
     cover a large area and this makes it harder to see the sequence of events 
     in the town itself.

### Adding arrows and curves

To add an arrow to the end of each line segment we can use the `arrow()`
helper function from the `ggplot2` package to specify the `arrow` argument of
the `geom_segment()` function in our `ggmap()` stack. Here, we make the arrow
head smaller than the default by setting `length = unit(3, "mm")` and choose the
style of the arrow head with `type = "closed"`.

To prevent the arrow heads from obscuring the points, we will give the points a
thin white border by specifying `shape = 21` (a circle with a separate border)
and `colour = "white"`, as well as making the points slightly bigger with 
`size = 3`.

```{r linked-exercise3, exercise=TRUE, exercise.lines=19, out.width="100%"}
ggmap(hungerford_basemap) +
  geom_segment(
    aes(x = x_start, y = y_start, xend = x_end, yend = y_end),
    data = hungerford_lines, 
    inherit.aes = FALSE,
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    colour = "orange3"
  ) +
  geom_point(
    aes(x = x, y = y), 
    data = hungerford_wgs84, 
    inherit.aes = FALSE,
    shape = 21,
    colour = "white",
    fill = "orange3",
    size = 3
  ) +
  theme_void()
```

This makes it easier to see that the shootings started at the point on the left
of the map, but makes the problem of understanding the sequence of events in the
town itself even worse. We will deal with this in the next section.

In the map above, we used the `geom_segment()` function to add the lines to our
map. If we change this to `geom_curve()` the lines will become curved rather
than straight. By specifying `curvature = -0.2` we get a slightly straighter
line than the default, and a left-hand curve because the value of `curvature` is
negative (play around with this in the code box below to see how this argument
works).

Behind the scenes, R has to make various calculations to create the curved line
between each shooting. These calculations are made more complicated by the base
map layer on the map being an SF object and the point and line layers being
data frames. To make these calculations possible, we have to specify 
`coord_sf(crs = 4326)` -- if you forget to do this you will see a warning 
`geom_curve is not implemented for non-linear coordinates` and the curves on the
map will be obviously incorrect. We will save this map as an object because we
will need it later on.

The other layer we can add to our map is a layer of labels showing the order in
which the shootings occurred. We don't want the labels to overlap the points, so
we will use `geom_label_repel()` from the `ggrepel` package to create labels 
that are automatically offset from the points they relate to. For now, we will
just label the first two locations. 

At this point we can also make some minor changes to the map -- adding a title
and scale bar, putting a neat line around the map -- the purpose of which will
become clear in the next section.

```{r linked-exercise4, exercise=TRUE, exercise.lines=42, out.width="100%"}
library(ggrepel)

hungerford_map_overall <- ggmap(hungerford_basemap) +
  geom_curve(
    aes(x = x_start, y = y_start, xend = x_end, yend = y_end),
    data = hungerford_lines, 
    inherit.aes = FALSE,
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    curvature = -0.2,
    colour = "orange3"
  ) +
  geom_point(
    aes(x = x, y = y), 
    data = hungerford_wgs84, 
    inherit.aes = FALSE,
    shape = 21,
    colour = "white",
    fill = "orange3",
    size = 3
  ) +
  geom_label_repel(
    aes(x = x, y = y, label = order),
    data = filter(hungerford_wgs84, order %in% 1:2), 
    inherit.aes = FALSE,
    colour = "white",
    fill = "orange3",
    fontface = "bold",
    label.size = NA,
  ) +
  annotation_scale(style = "ticks", line_col = "grey40", text_col = "grey40") +
  labs(
    title = " Shootings in Wiltshire"
  ) +
  coord_sf(crs = 4326) +
  theme_void() +
  theme(
    panel.border = element_rect(colour = "grey20", fill = NA),
    plot.title = element_text(margin = margin(b = -18))
  )

hungerford_map_overall
```

Now we have added arrow heads and curved lines, in the next section we will
learn how to solve the problem of the events in the town itself being unclear on
the map.



## Multiple maps

<p class="full-width-image"><img src="images/patchwork_1.jpg" alt="Cartoon showing furry monsters arranging three picture frames hanging from a wall."></p>

Our existing map is difficult to understand because we have a mix of some events
very close together (including several on the same street) and some that 
occurred further away. This means the closer events overlap on the map, 
especially now that we have made the points larger to distinguish them from the
lines linking each event.

<a href="https://patchwork.data-imaginist.com/"><img src="images/patchwork.png" alt="patchwork package logo" class="right-side-image"></a>

To deal with this problem we can display two maps: one showing the whole area 
covered by the points and a second (sometimes called an *inset map*) showing 
only the events in the town of Hungerford itself. We will do this using the 
[`patchwork` package](https://patchwork.data-imaginist.com/) to combine multiple
maps made using `ggmap()`.

We have already saved the first map as `hungerford_map_overall`. We can create a
map showing only the shootings in Hungerford itself by removing the first two
points from `hungerford_sf` then downloading a new base map based on that layer 
and plotting the result. Because some rows in the data will be outside the map
area, we will add `na.rm = TRUE` to each layer to specify that off-map rows 
should be removed from the data without generating a warning.

We will use the `plot.margin` argument to the `theme()` function to add a small 
amount of space at the top of this map, which will help separate it from the 
first map when we put them together.

```{r multiple-exercise1, exercise=TRUE, exercise.lines=54, fig.asp=1}
hungerford_town_bbox <- hungerford_sf %>% 
  slice(3:n()) %>% 
  st_transform(27700) %>% 
  st_buffer(100) %>% 
  st_transform(4326) %>% 
  st_bbox()

hungerford_town_basemap <- hungerford_town_bbox %>% 
  set_names(c("left", "bottom", "right", "top")) %>%
  get_stamenmap(zoom = 16, maptype = "toner-lite")

hungerford_map_town <- ggmap(hungerford_town_basemap) +
  geom_curve(
    aes(x = x_start, y = y_start, xend = x_end, yend = y_end),
    data = hungerford_lines, 
    inherit.aes = FALSE,
    na.rm = TRUE,
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    curvature = -0.2,
    colour = "orange3",
    size = 1
  ) +
  geom_point(
    aes(x = x, y = y), 
    data = hungerford_wgs84, 
    inherit.aes = FALSE,
    na.rm = TRUE,
    shape = 21,
    colour = "white",
    fill = "orange3",
    size = 3
  ) +
  geom_label_repel(
    aes(x = x, y = y, label = order),
    data = hungerford_wgs84, 
    inherit.aes = FALSE,
    na.rm = TRUE,
    colour = "white",
    fill = "orange3",
    fontface = "bold",
    label.size = NA,
  ) +
  annotation_scale(style = "ticks", line_col = "grey40", text_col = "grey40") +
  coord_sf(crs = 4326) +
  labs(
    title = "Shootings in Hungerford town"
  ) +
  theme_void() +
  theme(
    panel.border = element_rect(colour = "grey20", fill = NA),
    plot.margin = margin(t = 12)
  )

hungerford_map_town
```

We can now combine the two maps using the `patchwork` package. To place two 
plots next to each other using `patchwork` you just add one map object to the
other using the `|` operator. To place one plot on top of the other, you use the
`/` operator (you can combine plots in more-complicated ways by combining these
operators, together with parentheses).

```{r multiple-exercise2, exercise=TRUE, fig.asp=1}
library(patchwork)

(hungerford_map_overall / hungerford_map_town)
```

When we created the `hungerford_map_overall` object in the previous section, we
gave the map title a negative border using the `plot.title` argument to the
`theme()` function. This had the effect of moving the title downwards onto the
map to save space, since the top-left corner of the map was empty. We also added
a scale bar, since when you present two related maps of different scales next to 
one another, it is useful to show the scales of both maps to help readers relate
them to one another.

When we present two maps together and one of them shows an area that includes
the area covered by the other one, it is also helpful to readers to show the
area of the larger-scale map on the smaller-scale map. Since the area covered by
the Hungerford town map is determined by a buffered bounding box around the
shooting locations, we can add this same area to the overall shootings map. To
do this, we convert the bounding box of the town shootings we stored as
`hungerford_town_bbox` to an SF object using the `st_as_sfc()` function.

We will also add a label explaining what the box shows using the `annotate()`
function from `ggplot2`. `annotate()` acts like the `geom_` family of functions,
except that we can specify the values of aesthetics like `x` and `y` directly
as arguments, rather than by pointing to columns in a dataset.

```{r multiple-exercise3, exercise=TRUE, exercise.lines=20, fig.asp=1}
hungerford_map_overall2 <- hungerford_map_overall + 
  geom_sf(
    data = st_as_sfc(hungerford_town_bbox), 
    inherit.aes = FALSE, 
    fill = NA
  ) +
  annotate(
    geom = "label", 
    x = pluck(hungerford_town_bbox, "xmin"), 
    y = pluck(hungerford_town_bbox, "ymin"),
    label = "area covered\nby map below",
    hjust = 1,
    label.size = NA,
    lineheight = 0.9,
    size = 2.5,
    vjust = 1
  )

(hungerford_map_overall2 / hungerford_map_town)
```

We can add shared titles and captions to combined maps created with `patchwork`
using the `plot_annotation()` function. This function has a `theme` argument,
which we can use to change the appearance of the shared title and caption just
as we use `theme()` to change the appearance of elements on single maps.

```{r multiple-exercise4, exercise=TRUE, fig.asp=1}
(hungerford_map_overall2 / hungerford_map_town) + plot_annotation(
  title = "Shootings during the Hungerford massacre",
  caption = "data from the official report into the shootings",
  theme = theme(
    plot.caption = element_text(colour = "grey40"),
    plot.title = element_text(colour = "grey50", face = "bold", size = 16)
  )
)
```

There are various other improvements that we could make to this map based on the
mapping skills we have already learned during this course. For example, we could
add the locations of buildings or particular facilities using data from 
OpenStreetMap. What information we choose to present on the map will depend on 
what information we think it is important to communicate to our audience.

<p class="credits">[Stats Illustrations by Allison Horst](https://github.com/allisonhorst/stats-illustrations) licensed under the [Creative Commons Attribution licence](https://github.com/allisonhorst/stats-illustrations/blob/master/license).</p>


<!--
## Plotting the journey to crime

For many crimes (especially predatory crimes), offenders must travel to and from 
the location of the offence. Investigators will sometimes know some points along
this journey, but not the whole route. For example, detectives investigating a
kidnapping murder may know where the victim was taken from and where the body 
was found, but not know where the offender or victim were between those points.
For a more-common crime such as car theft, police may know where a car was 
stolen from and where it was recovered, but not have any information about where
it was between those times.

When investigating crimes involving travel between points, it will often be 
useful to work out the route taken between two points. For example, establishing
a possible route might make it possible to check CCTV cameras, analyse toll-road 
records or seek witnesses along the way. A potential route might also allow an
analyst to consider whether any other crimes along that route might be part of a
crime series. If pairs of points are known for multiple crimes that are believed
to be a linked series, it is possible that looking for overlapping parts of the 
routes between pairs of points might help identify the offender's anchor point.

We can plot the fastest route between two locations on foot or in a vehicle 
using tools that were designed for transport planning. The 
[`stplanr` package](https://docs.ropensci.org/stplanr/) uses data from the
OpenStreetMap routing service to work out the fastest route between two points.
-->



## In summary

<div class="box welldone">

In this tutorial we have learned how to map crime series, focusing on displaying
a sequence of events on a map. We have also learned how to combine maps using 
the `patchwork` package.

</div>

You can put the code from this tutorial together to see everything that is 
needed to make a composite map of the Hungerford massacre from the original data 
file called `hungerford_shootings`.

```{r summary-exercise1, exercise=TRUE, exercise.lines=160, fig.asp=1}
library(ggmap)
library(sf)
library(tidyverse)



# Prepare data -----------------------------------------------------------------

# Convert data to SF
hungerford_sf <- hungerford_shootings %>%
  arrange(order) %>% 
  st_as_sf(coords = c("easting", "northing"), crs = 27700)

# Transform data and extract co-ordinates
hungerford_wgs84 <- hungerford_sf %>% 
  st_transform(4326) %>% 
  st_coordinates() %>% 
  as_tibble() %>% 
  janitor::clean_names() %>% 
  mutate(order = row_number())

# Derive lines between points from point co-ordinates
hungerford_lines <- hungerford_wgs84 %>% 
  rename(x_end = x, y_end = y) %>% 
  mutate(x_start = lag(x_end), y_start = lag(y_end)) %>% 
  slice(2:n())

# Calculate bounded box for town centre and buffer it
hungerford_town_bbox <- hungerford_sf %>% 
  slice(3:n()) %>% 
  st_transform(27700) %>% 
  st_buffer(100) %>% 
  st_transform(4326) %>% 
  st_bbox()

# Download overall basemap
hungerford_basemap <- hungerford_sf %>% 
  st_buffer(1000) %>% 
  st_transform(4326) %>% 
  st_bbox() %>% 
  set_names(c("left", "bottom", "right", "top")) %>%
  get_stamenmap(zoom = 13, maptype = "toner-lite")

# Download town basemap
hungerford_town_basemap <- hungerford_town_bbox %>% 
  set_names(c("left", "bottom", "right", "top")) %>%
  get_stamenmap(zoom = 16, maptype = "toner-lite")



# Make component maps ----------------------------------------------------------

hungerford_map_overall <- ggmap(hungerford_basemap) +
  geom_curve(
    aes(x = x_start, y = y_start, xend = x_end, yend = y_end),
    data = hungerford_lines, 
    inherit.aes = FALSE,
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    curvature = -0.2,
    colour = "orange3"
  ) +
  geom_point(
    aes(x = x, y = y), 
    data = hungerford_wgs84, 
    inherit.aes = FALSE,
    shape = 21,
    colour = "white",
    fill = "orange3",
    size = 3
  ) +
  geom_label_repel(
    aes(x = x, y = y, label = order),
    data = filter(hungerford_wgs84, order %in% 1:2), 
    inherit.aes = FALSE,
    colour = "white",
    fill = "orange3",
    fontface = "bold",
    label.size = NA,
  ) +
  geom_sf(
    data = st_as_sfc(hungerford_town_bbox), 
    inherit.aes = FALSE, 
    fill = NA
  ) +
  annotate(
    geom = "label", 
    x = pluck(hungerford_town_bbox, "xmin"), 
    y = pluck(hungerford_town_bbox, "ymin"),
    label = "area covered\nby map below",
    hjust = 1,
    label.size = NA,
    lineheight = 0.9,
    size = 2.5,
    vjust = 1
  ) +
  annotation_scale(style = "ticks", line_col = "grey40", text_col = "grey40") +
  labs(
    title = " Shootings in Wiltshire"
  ) +
  coord_sf(crs = 4326) +
  theme_void() +
  theme(
    panel.border = element_rect(colour = "grey20", fill = NA),
    plot.title = element_text(margin = margin(b = -18))
  )

hungerford_map_town <- ggmap(hungerford_town_basemap) +
  geom_curve(
    aes(x = x_start, y = y_start, xend = x_end, yend = y_end),
    data = hungerford_lines, 
    inherit.aes = FALSE,
    na.rm = TRUE,
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    curvature = -0.2,
    colour = "orange3",
    size = 1
  ) +
  geom_point(
    aes(x = x, y = y), 
    data = hungerford_wgs84, 
    inherit.aes = FALSE,
    na.rm = TRUE,
    shape = 21,
    colour = "white",
    fill = "orange3",
    size = 3
  ) +
  geom_label_repel(
    aes(x = x, y = y, label = order),
    data = hungerford_wgs84, 
    inherit.aes = FALSE,
    na.rm = TRUE,
    colour = "white",
    fill = "orange3",
    fontface = "bold",
    label.size = NA,
  ) +
  annotation_scale(style = "ticks", line_col = "grey40", text_col = "grey40") +
  coord_sf(crs = 4326) +
  labs(
    title = "Shootings in Hungerford town"
  ) +
  theme_void() +
  theme(
    panel.border = element_rect(colour = "grey20", fill = NA),
    plot.margin = margin(t = 12)
  )



# Combine maps and add titles --------------------------------------------------

(hungerford_map_overall / hungerford_map_town) + plot_annotation(
  title = "Shootings during the Hungerford massacre",
  caption = "data from the official report into the shootings",
  theme = theme(
    plot.caption = element_text(colour = "grey40"),
    plot.title = element_text(colour = "grey50", face = "bold", size = 16)
  )
)

```

